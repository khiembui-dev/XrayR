#!/usr/bin/env bash
set -euo pipefail

# =======================
#  CONFIG M·∫∂C ƒê·ªäNH (S·ª¨A T√ôY √ù)
# =======================
API_HOST="https://panel.kingvpn.vn"
API_KEY="khiemdeptrailaso1"

DEFAULT_NODEID_VMESS=157
DEFAULT_NODEID_TROJAN=319
DEFAULT_NODEID_VLESS=157
DEFAULT_NODEID_SS=400

XRAYR_CONFIG="/etc/XrayR/config.yml"
CERT_DIR="/etc/XrayR/cert"
CERT_FILE="$CERT_DIR/node1.test.com.cert"
KEY_FILE="$CERT_DIR/node1.test.com.key"
ACCESS_LOG="/etc/XrayR/access.log"
ERROR_LOG="/etc/XrayR/error.log"

# =======================
#  MENU CH·ªåN GIAO TH·ª®C
# =======================
echo "Ch·ªçn lo·∫°i c√†i ƒë·∫∑t node:"
echo "  1) Ch·ªâ VMess"
echo "  2) Ch·ªâ Trojan (TLS)"
echo "  3) Ch·ªâ VLESS (TLS ‚Äì gRPC)"
echo "  4) VMess + Trojan + VLESS (m·∫∑c ƒë·ªãnh)"
echo "  5) Ch·ªâ Shadowsocks (SS)"
read -p "L·ª±a ch·ªçn [1/2/3/4/5]: " MODE
MODE="${MODE:-4}"

# =======================
#  H·ªéI NODE ID THEO CH·∫æ ƒê·ªò
# =======================
case "$MODE" in
  1)
    read -p "NODE ID VMess (default ${DEFAULT_NODEID_VMESS}): " NODE_VMESS
    NODE_VMESS="${NODE_VMESS:-$DEFAULT_NODEID_VMESS}"
    ;;
  2)
    read -p "NODE ID Trojan (default ${DEFAULT_NODEID_TROJAN}): " NODE_TROJAN
    NODE_TROJAN="${NODE_TROJAN:-$DEFAULT_NODEID_TROJAN}"
    ;;
  3)
    read -p "NODE ID VLESS (TLS ‚Äì gRPC) (default ${DEFAULT_NODEID_VLESS}): " NODE_VLESS
    NODE_VLESS="${NODE_VLESS:-$DEFAULT_NODEID_VLESS}"
    ;;
  4)
    read -p "NODE ID VMess (default ${DEFAULT_NODEID_VMESS}): " NODE_VMESS
    NODE_VMESS="${NODE_VMESS:-$DEFAULT_NODEID_VMESS}"
    read -p "NODE ID Trojan (default ${DEFAULT_NODEID_TROJAN}): " NODE_TROJAN
    NODE_TROJAN="${NODE_TROJAN:-$DEFAULT_NODEID_TROJAN}"
    read -p "NODE ID VLESS (TLS ‚Äì gRPC) (default ${DEFAULT_NODEID_VLESS}): " NODE_VLESS
    NODE_VLESS="${NODE_VLESS:-$DEFAULT_NODEID_VLESS}"
    ;;
  5)
    read -p "NODE ID Shadowsocks (default ${DEFAULT_NODEID_SS}): " NODE_SS
    NODE_SS="${NODE_SS:-$DEFAULT_NODEID_SS}"
    ;;
  *)
    echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá"; exit 1;;
esac

# =======================
#  C√ÄI XRAYR
# =======================
echo "[‚Ä¢] C√†i ƒë·∫∑t XrayR‚Ä¶"
bash <(curl -Ls https://raw.githubusercontent.com/wyx2685/XrayR-release/master/install.sh)

# =======================
#  CHU·∫®N B·ªä TH∆Ø M·ª§C & LOG
# =======================
install -d -m 755 /etc/XrayR
install -d -m 755 "$CERT_DIR"
touch "$ACCESS_LOG" "$ERROR_LOG"
chmod 644 "$ACCESS_LOG" "$ERROR_LOG"

# N·∫øu b·∫°n c√≥ CERT th·∫≠t, d√°n ·ªü ƒë√¢y; t·∫°m th·ªùi d√πng placeholder
if [[ ! -s "$CERT_FILE" ]]; then
  cat >"$CERT_FILE" <<'EOF'
-----BEGIN CERTIFICATE-----
(PASTE CERT TH·∫¨T ·ªû ƒê√ÇY)
-----END CERTIFICATE-----
EOF
fi
if [[ ! -s "$KEY_FILE" ]]; then
  cat >"$KEY_FILE" <<'EOF'
-----BEGIN PRIVATE KEY-----
(PASTE PRIVATE KEY TH·∫¨T ·ªû ƒê√ÇY)
-----END PRIVATE KEY-----
EOF
fi
chmod 600 "$KEY_FILE" || true
chmod 644 "$CERT_FILE" || true

# =======================
#  H√ÄM APPEND NODE
# =======================
append_vmess() {
cat >>"$XRAYR_CONFIG" <<EOF
  - PanelType: "NewV2board"
    ApiConfig:
      ApiHost: "${API_HOST}"
      ApiKey: "${API_KEY}"
      NodeID: ${NODE_VMESS}
      NodeType: V2ray
      Timeout: 30
    ControllerConfig:
      ListenIP: 0.0.0.0
      SendIP: 0.0.0.0
      UpdatePeriodic: 10
      EnableDNS: false
      DNSType: AsIs
      DeviceOnlineMinTraffic: 100
      EnableProxyProtocol: false
      DisableLocalREALITYConfig: true
      EnableREALITY: false
EOF
}

append_trojan() {
cat >>"$XRAYR_CONFIG" <<EOF
  - PanelType: "NewV2board"
    ApiConfig:
      ApiHost: "${API_HOST}"
      ApiKey: "${API_KEY}"
      NodeID: ${NODE_TROJAN}
      NodeType: Trojan
      Timeout: 30
    ControllerConfig:
      ListenIP: 0.0.0.0
      SendIP: 0.0.0.0
      UpdatePeriodic: 10
      EnableDNS: false
      DNSType: AsIs
      DeviceOnlineMinTraffic: 100
      EnableProxyProtocol: false
      DisableLocalREALITYConfig: true
      EnableREALITY: false
      CertConfig:
        CertMode: file
        CertFile: ${CERT_FILE}
        KeyFile: ${KEY_FILE}
EOF
}

append_vless_tls() {
cat >>"$XRAYR_CONFIG" <<EOF
  - PanelType: "NewV2board"
    ApiConfig:
      ApiHost: "${API_HOST}"
      ApiKey: "${API_KEY}"
      NodeID: ${NODE_VLESS}
      NodeType: V2ray
      Timeout: 30
      EnableVless: true
      VlessFlow: ""               # TLS thu·∫ßn (kh√¥ng REALITY)
    ControllerConfig:
      ListenIP: 0.0.0.0
      SendIP: 0.0.0.0
      UpdatePeriodic: 10
      EnableDNS: false
      DNSType: AsIs
      DeviceOnlineMinTraffic: 100
      EnableProxyProtocol: false
      DisableLocalREALITYConfig: true
      EnableREALITY: false
      CertConfig:
        CertMode: file
        CertFile: ${CERT_FILE}
        KeyFile: ${KEY_FILE}
EOF
}

append_shadowsocks() {
cat >>"$XRAYR_CONFIG" <<EOF
  - PanelType: "NewV2board"
    ApiConfig:
      ApiHost: "${API_HOST}"
      ApiKey: "${API_KEY}"
      NodeID: ${NODE_SS}
      NodeType: Shadowsocks
      Timeout: 30
    ControllerConfig:
      ListenIP: 0.0.0.0
      SendIP: 0.0.0.0
      UpdatePeriodic: 10
      EnableDNS: false
      DNSType: AsIs
      DeviceOnlineMinTraffic: 100
      EnableProxyProtocol: false
      DisableLocalREALITYConfig: true
      EnableREALITY: false
EOF
}

# =======================
#  GHI FILE CONFIG CH√çNH
# =======================
echo "[‚Ä¢] T·∫°o $XRAYR_CONFIG‚Ä¶"
cat >"$XRAYR_CONFIG" <<EOF
Log:
  Level: warning
  AccessPath: ${ACCESS_LOG}
  ErrorPath: ${ERROR_LOG}

ConnectionConfig:
  Handshake: 4
  ConnIdle: 30
  UplinkOnly: 2
  DownlinkOnly: 4
  BufferSize: 64

Nodes:
EOF

# Append theo l·ª±a ch·ªçn
case "$MODE" in
  1) append_vmess ;;
  2) append_trojan ;;
  3) append_vless_tls ;;
  4) append_vmess; append_trojan; append_vless_tls ;;
  5) append_shadowsocks ;;
esac

# =======================
#  MENU QU·∫¢N L√ù NHANH
# =======================
cat >/root/xrayr <<'MENU'
#!/usr/bin/env bash
while true; do
  clear
  echo "====== XrayR Menu ======"
  echo "1) S·ª≠a config (/etc/XrayR/config.yml)"
  echo "2) Restart XrayR"
  echo "3) Xem log (journalctl -u XrayR -e)"
  echo "4) G·ª° XrayR"
  echo "0) Tho√°t"
  echo "========================"
  read -p "Ch·ªçn: " c
  case "$c" in
    1) ${EDITOR:-nano} /etc/XrayR/config.yml ;;
    2) XrayR restart || systemctl restart XrayR ;;
    3) journalctl -u XrayR -e --no-pager | tail -n 200 ; read -p "Nh·∫•n Enter ƒë·ªÉ v·ªÅ menu..." ;;
    4) XrayR uninstall ;;
    0) exit 0 ;;
    *) echo "L·ª±a ch·ªçn kh√¥ng h·ª£p l·ªá!"; sleep 1 ;;
  esac
done
MENU
chmod +x /root/xrayr

# =======================
#  KH·ªûI ƒê·ªòNG L·∫†I D·ªäCH V·ª§
# =======================
echo "[‚Ä¢] Restart XrayR‚Ä¶"
XrayR restart || systemctl restart XrayR

echo
echo "‚úÖ Ho√†n t·∫•t!"
echo "üìÑ Config: $XRAYR_CONFIG"
echo "üìú Log: $ACCESS_LOG , $ERROR_LOG"
echo "üõ†  Menu: /root/xrayr"
